# Расчет требований к кластеру Kubernetes

## 1. Расчет ресурсов по компонентам

### База данных
- **Требования на копию**: 4 ГБ ОЗУ, 1 ядро
- **Количество копий**: 3 (отказоустойчивая конфигурация)
- **Общие ресурсы**: 12 ГБ ОЗУ, 3 ядра

### Кеш
- **Требования на копию**: 4 ГБ ОЗУ, 1 ядро
- **Количество копий**: 3 (отказоустойчивая конфигурация)
- **Общие ресурсы**: 12 ГБ ОЗУ, 3 ядра

### Фронтенд
- **Требования на копию**: 50 МБ ОЗУ, 0.2 ядра
- **Количество копий**: 5
- **Общие ресурсы**: 250 МБ ОЗУ, 1 ядро

### Бекенд
- **Требования на копию**: 600 МБ ОЗУ, 1 ядро
- **Количество копий**: 10
- **Общие ресурсы**: 6 ГБ ОЗУ, 10 ядер

## 2. Суммарные требования к ресурсам

### Общие ресурсы приложения:
- **RAM**: 12 + 12 + 0.25 + 6 = **30.25 ГБ**
- **CPU**: 3 + 3 + 1 + 10 = **17 ядер**

### Детальный расчет системных ресурсов Kubernetes:

#### Control Plane (3 ноды для HA):
- **На ноду**: 4 CPU cores, 8 GB RAM
- **Всего**: 12 CPU, 24 GB RAM
- **Обоснование**: etcd, kube-apiserver, kube-controller-manager, kube-scheduler

#### Worker nodes overhead (на каждую worker ноду):
- **kubelet**: 256 MB RAM, 0.2 CPU
- **kube-proxy**: 128 MB RAM, 0.05 CPU
- **Container runtime** (containerd): 512 MB RAM, 0.1 CPU
- **CNI plugin** (Calico): 256 MB RAM, 0.1 CPU
- **Monitoring** (если установлен): 256 MB RAM, 0.1 CPU
- **Logging agents**: 128 MB RAM, 0.05 CPU
- **Итого на worker ноду**: ~1.5 GB RAM, ~0.6 CPU

#### Системные ресурсы на кластер:
- **Database nodes** (2 ноды × 1.5 GB RAM, 0.6 CPU): 3 GB RAM, 1.2 CPU
- **Application nodes** (3 ноды × 1.5 GB RAM, 0.6 CPU): 4.5 GB RAM, 1.8 CPU
- **Control Plane**: 24 GB RAM, 12 CPU
- **Общий системный overhead**: ~31.5 GB RAM, ~15 CPU

### Итого с учетом системных ресурсов:
- **RAM**: 30.25 + системные ресурсы
- **CPU**: 17 + системные ресурсы

## 3. Определение требований к нодам

### Стратегия размещения компонентов:
- **База данных**: Требует высокой производительности I/O, лучше на dedicated нодах
- **Кеш**: Высокая нагрузка на CPU/RAM, может делить ноды с БД
- **Фронтенд**: Низкие требования, может размещаться с бекендом
- **Бекенд**: Высокая нагрузка на CPU, лучше на отдельных application нодах

### Рекомендуемые характеристики нод:

#### Database nodes (для БД и кеша):
- **CPU**: 8 ядер
- **RAM**: 32 ГБ
- **Количество**: 2 ноды
- **Обоснование**: БД + кеш = 24 ГБ RAM, 6 ядер + системные ресурсы

#### Application nodes (для бекенда и фронтенда):
- **CPU**: 16 ядер
- **RAM**: 32 ГБ
- **Количество**: 3 ноды
- **Обоснование**: Бекенд = 6 ГБ RAM, 10 ядер + фронтенд = 0.25 ГБ RAM, 1 ядро + системные ресурсы

#### Итого нод:
- **Database nodes**: 2 × (8 CPU, 32 GB RAM)
- **Application nodes**: 3 × (16 CPU, 32 GB RAM)
- **Всего**: 5 нод

## 4. Расчет запаса на отказоустойчивость

### Сценарий отказа одной ноды:

#### Отказ Database ноды:
- **Оставшиеся ресурсы**: 1 × (8 CPU, 32 GB RAM)
- **Текущая нагрузка**: БД + кеш = 24 GB RAM, 6 ядер
- **Запас**: 32 - 24 = 8 GB RAM, 8 - 6 = 2 ядра
- **Статус**: Достаточно для работы (33% запас)

#### Отказ Application ноды:
- **Оставшиеся ресурсы**: 2 × (16 CPU, 32 GB RAM) = 32 CPU, 64 GB RAM
- **Текущая нагрузка**: Бекенд + фронтенд = 6.25 GB RAM, 11 ядер
- **Запас**: 64 - 6.25 = 57.75 GB RAM, 32 - 11 = 21 ядра
- **Статус**: Достаточно для работы (87% запас)

### Дополнительный запас на рост нагрузки:
- **Рост нагрузки**: +30% (стандартная практика)
- **Дополнительные ресурсы**: ~9 GB RAM, ~5 ядер
- **Итого с запасом**: ~40 GB RAM, ~22 ядер на кластер

## 5. Финальные характеристики нод

### Итоговые требования к кластеру:

#### Application ресурсы:
- **RAM**: 30.25 GB
- **CPU**: 17 ядер

#### Системные ресурсы:
- **RAM**: 31.5 GB
- **CPU**: 15 ядер

#### Запас на отказоустойчивость и рост:
- **RAM**: +30% = ~18.5 GB
- **CPU**: +30% = ~9.7 ядер

### Рекомендуемая конфигурация кластера:

#### Control Plane (управляется провайдером или отдельные ноды):
- **3 ноды** по 4 CPU, 8 GB RAM каждая
- **Итого**: 12 CPU, 24 GB RAM

#### Worker Nodes:

**Database Nodes** (2 ноды):
- **Характеристики**: 8 CPU cores, 32 GB RAM
- **Назначение**: База данных + Кеш
- **Ресурсы на ноду**: ~16 GB RAM, 4 CPU (с запасом)

**Application Nodes** (3 ноды):
- **Характеристики**: 16 CPU cores, 64 GB RAM
- **Назначение**: Бекенд + Фронтенд
- **Ресурсы на ноду**: ~21 GB RAM, 8 CPU (с запасом)

### Итого по кластеру:
- **Control Plane**: 3 × (4 CPU, 8 GB RAM)
- **Database nodes**: 2 × (8 CPU, 32 GB RAM)
- **Application nodes**: 3 × (16 CPU, 64 GB RAM)
- **Всего**: 8 нод, 60 CPU cores, 280 GB RAM

## 6. Helm Chart для развертывания

Создан Helm чарт `helm-chart/` для автоматизированного развертывания приложения в разных окружениях.

### Структура чарта:
- `Chart.yaml` - метаданные чарта
- `values.yaml` - базовые параметры (staging)
- `values-dev.yaml` - параметры для development окружения
- `values-prod.yaml` - параметры для production окружения
- `templates/` - Kubernetes манифесты для всех компонентов

### Компоненты чарта:
1. **Database**: StatefulSet с PostgreSQL, PVC для данных
2. **Cache**: StatefulSet с Redis, PVC для данных
3. **Backend**: Deployment с API сервером
4. **Frontend**: Deployment с веб-интерфейсом и Ingress

### Использование:
```bash
# Development
helm install my-app ./helm-chart -f helm-chart/values-dev.yaml

# Production
helm install my-app ./helm-chart -f helm-chart/values-prod.yaml
```

## Заключение

### Итоговые рекомендации:

1. **Кластер из 8 нод**:
   - 3 control plane ноды (4 CPU, 8 GB RAM каждая)
   - 2 database ноды (8 CPU, 32 GB RAM каждая)
   - 3 application ноды (16 CPU, 64 GB RAM каждая)

2. **Общие ресурсы**: 280 GB RAM, 60 CPU cores

3. **Отказоустойчивость**: кластер выдержит отказ одной ноды любого типа

4. **Масштабируемость**: 30% запас на рост нагрузки

5. **Развертывание**: Helm чарт готов к использованию в dev/staging/prod окружениях

### Дополнительные рекомендации:
- Использовать StorageClass с SSD для database/cache
- Настроить monitoring (Prometheus + Grafana)
- Настроить backup для базы данных
- Использовать Network Policies для безопасности
- Рассмотреть использование node affinity для оптимального размещения подов